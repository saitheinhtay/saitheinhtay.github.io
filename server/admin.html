<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Admin - Exchange Accounts</title>
  <style>body{font-family:Inter,Arial;margin:20px}label{display:block;margin-top:8px}input,select{padding:8px;width:100%;max-width:400px}button{margin-top:10px;padding:8px 12px}</style>
</head>
<body>
  <h2>Admin - Exchange Accounts</h2>
  <div>
    <label>API Username</label>
    <input id="adminUser" placeholder="admin">
    <label>API Password</label>
    <input id="adminPass" type="password" placeholder="password">
    <button id="authBtn">Set Auth (for this session)</button>
  </div>

  <hr>
  <h3>Add Account</h3>
  <div>
    <label>Name</label>
    <input id="name">
    <label>Exchange</label>
    <select id="exchange">
      <option>binance</option>
      <option>bybit</option>
      <option>mexc</option>
    </select>
    <label>API Key</label>
    <input id="apiKey">
    <label>API Secret</label>
    <input id="apiSecret">
    <label>Passphrase (optional)</label>
    <input id="passphrase">
    <button id="addAcct">Add Account</button>
  </div>

  <hr>
  <h3>Accounts</h3>
  <div id="accounts"></div>

  <hr>
  <h3>Agent Mode</h3>
  <div>
    <button id="toggleAgent">Toggle Agent</button>
    <button id="manualSync">Run Manual Sync</button>
    <pre id="status"></pre>
  </div>

<script>
let authHeader = null;

document.getElementById('authBtn').addEventListener('click', ()=>{
  const u = document.getElementById('adminUser').value || 'admin';
  const p = document.getElementById('adminPass').value || 'password';
  authHeader = 'Basic ' + btoa(u+':'+p);
  alert('Auth set for this session');
  loadAccounts();
  loadStatus();
});

async function api(path, opts={}){
  opts.headers = opts.headers||{};
  if(authHeader) opts.headers['Authorization'] = authHeader;
  const res = await fetch(path, opts);
  const txt = await res.text();
  try { return JSON.parse(txt); } catch(e){ return txt; }
}

async function addAccount(){
  const payload = {
    name: document.getElementById('name').value,
    exchange: document.getElementById('exchange').value,
    apiKey: document.getElementById('apiKey').value,
    apiSecret: document.getElementById('apiSecret').value,
    passphrase: document.getElementById('passphrase').value
  };
  const r = await api('/api/accounts',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
  alert(JSON.stringify(r));
  loadAccounts();
}

async function loadAccounts(){
  const r = await api('/api/accounts');
  const el = document.getElementById('accounts');
  if(!Array.isArray(r)) { el.textContent = JSON.stringify(r); return; }
  el.innerHTML = r.map(a=>`<div style="border:1px solid #ddd;padding:8px;margin:6px"><b>${a.name}</b> (${a.exchange})<br><button onclick="del('${a.id}')">Delete</button></div>`).join('');
}
async function del(id){ if(!confirm('Delete?')) return; const r = await api('/api/accounts/'+id,{method:'DELETE'}); alert(JSON.stringify(r)); loadAccounts(); }

async function toggleAgent(){
  const cur = await api('/api/status');
  const r = await api('/api/agent/toggle',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({enabled: !cur.agentMode})});
  alert(JSON.stringify(r)); loadStatus();
}
async function manualSync(){ const r = await api('/api/sync',{method:'POST'}); alert(JSON.stringify(r)); loadStatus(); }
async function loadStatus(){ const s = await api('/api/status'); document.getElementById('status').textContent = JSON.stringify(s,null,2); }

document.getElementById('addAcct').addEventListener('click', addAccount);
document.getElementById('toggleAgent').addEventListener('click', toggleAgent);
document.getElementById('manualSync').addEventListener('click', manualSync);

</script>
</body>
</html>